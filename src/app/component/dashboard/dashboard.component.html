<!-- Reusable fixed navbar -->
<app-navbar></app-navbar>

<!-- Page surface (add top padding to clear the fixed navbar) -->
<div
  class="relative min-h-screen w-full overflow-x-hidden pt-16 sm:pt-16
         bg-gradient-to-br from-slate-50 via-indigo-50 to-cyan-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950
         touch-pan-y">

  <!-- soft blobs -->
  <div aria-hidden="true"
       class="pointer-events-none fixed -top-20 -left-24 hidden md:block h-72 w-72 rounded-full
              bg-gradient-to-tr from-indigo-500 to-cyan-400 opacity-20 blur-3xl"></div>
  <div aria-hidden="true"
       class="pointer-events-none fixed -bottom-24 -right-24 hidden md:block h-96 w-96 rounded-full
              bg-gradient-to-tr from-fuchsia-500 to-indigo-500 opacity-20 blur-3xl"></div>

  <!-- Layout -->
  <div class="mx-auto grid max-w-7xl grid-cols-1 lg:grid-cols-[240px_minmax(0,1fr)]">
    <!-- Sidebar (desktop) -->
    <aside class="hidden lg:block lg:min-h-[calc(100vh-64px)] bg-white/70 dark:bg-slate-900/60 backdrop-blur ring-1 ring-black/5">
      <nav class="p-4 space-y-1">
        <div class="px-2 py-1 text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Navigation</div>
        <a routerLink="/dashboard" [routerLinkActiveOptions]="{exact:true}" routerLinkActive="bg-slate-100 dark:bg-slate-800"
           class="block rounded-xl px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800">Accueil</a>
        <a routerLink="/modules" class="block rounded-xl px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800">Modules</a>
        <a routerLink="/messages" class="block rounded-xl px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800">Messages</a>
        <a routerLink="/calendar" class="block rounded-xl px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800">Calendrier</a>

        <div class="mt-6 px-2 py-1 text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">Compte</div>
        <div class="rounded-xl bg-slate-50 p-3 ring-1 ring-slate-200 dark:bg-slate-800/60 dark:ring-slate-700">
          <ng-container *ngIf="me$ | async as me; else sideChipLoading">
            <div class="flex items-center gap-3">
              <div class="grid h-8 w-8 place-items-center rounded-full bg-indigo-600 text-[11px] font-bold text-white shadow">{{ initials(me) }}</div>
              <div class="text-sm break-all">{{ label(me) }}</div>
            </div>
          </ng-container>
          <ng-template #sideChipLoading>
            <div class="h-8 w-full rounded bg-slate-200 dark:bg-slate-700 animate-pulse"></div>
          </ng-template>
        </div>
      </nav>
    </aside>

    <!-- Main -->
    <main class="min-h-screen">
      <!-- Welcome -->
      <section class="px-4 pt-6">
        <div class="rounded-3xl bg-white/80 dark:bg-slate-900/70 backdrop-blur ring-1 ring-black/5 shadow-md p-5 md:p-6">
          <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div class="flex items-center gap-4">
              <div class="relative  hidden md:block">
                <img src="assets/img/fondation-gervais-logo.jpeg" class="md:h-12 md:w-12 h-8 w-8 rounded-2xl ring-2 ring-indigo-300/60" alt="">
                <span class="absolute -right-1 -bottom-1 h-3 w-3 rounded-full bg-emerald-500 ring-2 ring-white dark:ring-slate-900"></span>
              </div>
              <div>
                <h1 class="text-xl md:text-2xl font-bold text-slate-900 dark:text-white">
                  <ng-container *ngIf="me$ | async as me; else friendlyLoading">
                    Bonjour,
                    <span class="bg-gradient-to-r from-indigo-600 to-cyan-600 bg-clip-text text-transparent">
                      {{ friendlyName(me) }}
                    </span>
                  </ng-container>
                  <ng-template #friendlyLoading>
                    Bonjour, <span class="text-slate-400">…</span>
                  </ng-template>
                </h1>
                <p class="text-sm text-slate-600 dark:text-slate-300">Bienvenue sur l’espace de formation — Fondation Gervais ABC.</p>
              </div>
            </div>

            <div class="flex  md:flex-row flex-col gap-2 md:gap-4 space-y-6 md:space-y-0">
              <!-- <a routerLink="/modules" class="rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-indigo-700">Reprendre</a>
              <a routerLink="/calendar" class="rounded-xl px-4 py-2 text-sm font-semibold text-slate-700 ring-1 ring-slate-200 hover:bg-white/70 dark:text-slate-200 dark:ring-slate-700 dark:hover:bg-slate-800/60">Calendrier</a> -->
              <!-- NEW: Create course button -->
              <button (click)="openCreateCourse()" class="rounded-xl bg-indigo-600  px-4 py-2 text-sm font-semibold text-white shadow hover:bg-emerald-700">
                + Nouveau cours
              </button>
            </div>
          </div>
        </div>
      </section>



      <!-- NEW: My Courses -->
      <section class="px-4 pt-6">
        <div class="rounded-3xl bg-white/85 p-5 ring-1 ring-black/5 shadow-md dark:bg-slate-900/70">
          <div class="mb-3 flex items-center justify-between">
            <h2 class="text-lg font-semibold">Mes cours</h2>
            <button (click)="openCreateCourse()" class="rounded-lg px-3 py-1.5 text-sm font-semibold bg-indigo-600  text-white hover:bg-indigo-800 ">
              Créer un cours
            </button>
          </div>

          <ng-container *ngIf="myCourses$ | async as courses; else coursesLoading">
            <div *ngIf="courses.length; else noCourses" class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3">
              <div *ngFor="let c of courses" class="group rounded-2xl border border-slate-200/80 p-4 hover:shadow-lg transition dark:border-slate-800">
                <div class="font-medium">{{ c.title }}</div>
                <div class="text-sm text-slate-500 mt-1 max-h-12 overflow-hidden">
                  {{ c.description || '—' }}
                </div>
                <div class="mt-3 flex gap-2">
                  <button (click)="openEditCourse(c)" class="rounded-lg px-3 py-1.5 text-sm ring-1 ring-slate-200 hover:bg-white/70 dark:ring-slate-700 dark:hover:bg-slate-800">Modifier</button>
                  <button (click)="deleteCourse(c)" class="rounded-lg px-3 py-1.5 text-sm bg-rose-600 text-white hover:bg-rose-700">Supprimer</button>
                </div>
              </div>
            </div>

            <ng-template #noCourses>
              <div class="text-sm text-slate-500">
                Aucun cours pour l’instant.
                <button (click)="openCreateCourse()" class="text-indigo-600 hover:underline dark:text-indigo-400">Créer un cours</button>
              </div>
            </ng-template>
          </ng-container>

          <ng-template #coursesLoading>
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3">
              <div *ngFor="let i of [1,2,3]" class="rounded-2xl border border-slate-200/80 p-4 h-24 animate-pulse dark:border-slate-800"></div>
            </div>
          </ng-template>
        </div>
      </section>


      <!-- NEW: Create/Edit Course Modal -->
      <div *ngIf="showCourseDialog" class="fixed inset-0 z-50 grid place-items-center">
        <div class="absolute inset-0 bg-black/40" (click)="closeCourseDialog()"></div>
        <div class="relative w-full max-w-lg rounded-2xl bg-white p-5 ring-1 ring-black/10 shadow-xl dark:bg-slate-900 dark:ring-slate-700">
          <h3 class="text-lg font-semibold mb-4">{{ editCourse ? 'Modifier le cours' : 'Nouveau cours' }}</h3>
          <form (ngSubmit)="saveCourse()" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Titre</label>
              <input [(ngModel)]="courseForm.title" name="title" required minlength="3"
                class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-800 dark:border-slate-700"
                placeholder="Ex.: Introduction à la microfinance">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Description</label>
              <textarea [(ngModel)]="courseForm.description" name="description" rows="4"
                class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-800 dark:border-slate-700"
                placeholder="Résumé du cours…"></textarea>
            </div>
            <div class="flex justify-end gap-2">
              <button type="button" (click)="closeCourseDialog()"
                class="rounded-xl px-4 py-2 text-sm font-semibold text-slate-700 ring-1 ring-slate-200 hover:bg-white/70 dark:text-slate-200 dark:ring-slate-700 dark:hover:bg-slate-800/60">
                Annuler
              </button>
              <button type="submit" [disabled]="!courseForm.title || courseForm.title.length < 3"
                class="rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-indigo-700">
                {{ editCourse ? 'Enregistrer' : 'Créer' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>
</div>
